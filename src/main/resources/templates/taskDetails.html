<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Task 상세보기</title>
    <style>
        body { font-family: sans-serif; margin: 30px; }
        h1, h2 { margin-bottom: 10px; }
        .section { margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px;}
        .tags span {
            display: inline-block;
            background: #eef;
            color: #225;
            border-radius: 4px;
            padding: 4px 8px;
            margin: 2px;
            font-size: 13px;
        }
        form { margin-top: 8px; }
        textarea, input[type=text], select {
            width: 100%; max-width: 500px; padding: 6px;
            border: 1px solid #ccc; border-radius: 4px;
        }
        button {
            margin-top: 8px; padding: 6px 12px;
            border: 1px solid #999; border-radius: 4px;
            background: #f0f0f0; cursor: pointer;
        }
        button:hover { background: #ddd; }
        a { color: #06c; text-decoration: none; }
        .comment-item { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; }
    </style>
</head>
<body>

<h1>Task 상세보기</h1>

<div class="section" th:object="${taskDetails.task}">
    <strong>제목:</strong>
    <span th:text="*{title}"></span><br/>
    <strong>내용:</strong><br/>
    <p th:text="*{content}" style="white-space: pre-wrap;"></p>
</div>

<div class="section">
    <strong>마일스톤:</strong>
    <span th:text="${taskDetails.mileStone != null ? taskDetails.mileStone.name : '없음'}"></span>

    <form th:action="@{/projects/{pid}/tasks/{tid}/milestone(pid=${projectId}, tid=${taskDetails.task.id})}" method="post">
        <input type="hidden" name="_method" value="put">
        <label>마일스톤 변경:</label>
        <select name="mileStonId"> <option value="">(마일스톤 없음)</option>
            <option th:each="ms : ${allMilestones}"
                    th:value="${ms.id}"
                    th:text="${ms.name}"
                    th:selected="${taskDetails.mileStone != null && taskDetails.mileStone.id == ms.id}">
                마일스톤 이름
            </option>
        </select>
        <button type="submit">설정/변경</button>
    </form>
</div>

<div class="section">
    <h2>태그</h2>
    <div class="tags">
            <span th:each="tag : ${taskDetails.tags}">
              [[${tag.name}]]
              <form th:action="@{/projects/{pid}/tasks/{tid}/tags/{tagId}(pid=${projectId}, tid=${taskDetails.task.id}, tagId=${tag.id})}" method="post" style="display:inline;">
                    <input type="hidden" name="_method" value="delete">
                    <button type="submit" style="padding:0; background:none; border:none; color:#c00; cursor:pointer;">[삭제]</button>
              </form>
            </span>
    </div>

    <form th:action="@{/projects/{pid}/tasks/{tid}/tags(pid=${projectId}, tid=${taskDetails.task.id})}" method="post">
        <label>새 태그 추가:</label>
        <select name="tagId"> <option value="">(추가할 태그 선택)</option>
            <option th:each="tag : ${allTags}"
                    th:value="${tag.id}"
                    th:text="${tag.name}">
                태그 이름
            </option>
        </select>
        <button type="submit">추가</button>
    </form>
</div>

<div class="section">
    <h2>댓글</h2>

    <form th:action="@{/projects/{pid}/tasks/{tid}/comments(pid=${projectId}, tid=${taskDetails.task.id})}" method="post">
        <label for="comment-content">새 댓글:</label><br>
        <textarea id="comment-content" name="content" rows="3" required></textarea>
        <button type="submit">댓글 등록</button>
    </form>

    <hr style="margin-top: 20px;">

    <div th:if="${taskDetails.comments.isEmpty()}">
        <p>(댓글이 없습니다)</p>
    </div>
    <div th:unless="${taskDetails.comments.isEmpty()}">
        <div th:each="comment : ${taskDetails.comments}" class="comment-item">

            <div th:unless="${currentAccountId != null && comment.writerId == currentAccountId}">
                <strong>(작성자: [[${commentWriterMap[comment.writerId]}]])</strong>:
                <p th:text="${comment.content}" style="margin: 5px 0;"></p>
            </div>

            <div th:if="${currentAccountId != null && comment.writerId == currentAccountId}" style="display: flex; align-items: center;">
                <strong>(작성자: [[${commentWriterMap[comment.writerId]}]])</strong>:

                <form th:action="@{/projects/{pid}/tasks/{tid}/comments/{cid}(pid=${projectId}, tid=${taskDetails.task.id}, cid=${comment.id})}" method="post" style="display: inline-flex; align-items: center; margin-left: 10px; flex-grow: 1; margin-top: 0;">
                    <input type="hidden" name="_method" value="put">
                    <input type="text" name="content" th:value="${comment.content}" required style="flex-grow: 1; margin: 0 5px; padding: 4px;">
                    <button type="submit" style="padding: 4px 8px; margin-top:0;">수정</button>
                </form>

                <form th:action="@{/projects/{pid}/tasks/{tid}/comments/{cid}(pid=${projectId}, tid=${taskDetails.task.id}, cid=${comment.id})}" method="post" style="display: inline-flex; margin-left: 5px; margin-top: 0;">
                    <input type="hidden" name="_method" value="delete">
                    <button type="submit" th:onclick="return confirm('정말 이 댓글을 삭제하시겠습니까?')" style="padding: 4px 8px; margin-top:0;">삭제</button>
                </form>
            </div>

        </div>
    </div>
</div>
<div class="section">
    <a th:href="@{/projects/{pid}/tasks/{tid}/edit(pid=${projectId}, tid=${taskDetails.task.id})}">[수정하기]</a> |

    <form th:action="@{/projects/{pid}/tasks/{tid}(pid=${projectId}, tid=${taskDetails.task.id})}" method="post" style="display: inline-block; margin: 0 5px; margin-top: 0;">
        <input type="hidden" name="_method" value="delete">
        <button type="submit" th:onclick="return confirm('이 태스크를 삭제하시겠습니까?')"
                style="padding:0; background:none; border:none; color:#c00; cursor:pointer; text-decoration: underline;">
            [삭제하기]
        </button>
    </form>

    | <a th:href="@{/projects/{id}(id=${projectId})}">[프로젝트로 돌아가기]</a>
</div>


</body>
</html>